# Render Blueprint - Infrastructure as Code
# Defines all services and infrastructure for BIFPCL Website
# Deploy with: https://render.com/deploy

databases:
  - name: bifpcl-db
    databaseName: bifpcl
    user: bifpcl_user
    plan: free
    region: singapore
    postgresMajorVersion: 16

services:
  # ==========================================================================
  # Django Backend API
  # ==========================================================================
  - type: web
    name: bifpcl-api
    runtime: python
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: chmod +x build.sh && ./build.sh
    startCommand: gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --threads 2 --worker-class gthread --log-file -
    healthCheckPath: /api/health/
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: bifpcl-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: FRONTEND_URL
        value: "https://bifpcl-frontend.onrender.com"

# ==========================================================================
# React Frontend (Static Site)
# ==========================================================================
staticSites:
  - name: bifpcl-frontend
    region: singapore
    rootDir: frontend
    buildCommand: npm ci && npm run build
    staticPublishPath: dist
    pullRequestPreviewsEnabled: true
    envVars:
      - key: VITE_API_URL
        value: "https://bifpcl-api.onrender.com/api"
    headers:
      # Cache static assets aggressively
      - path: /assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
      # Don't cache index.html for proper updates
      - path: /index.html
        name: Cache-Control
        value: no-cache, no-store, must-revalidate
      # Security headers
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
    routes:
      # SPA fallback for client-side routing
      - type: rewrite
        source: /*
        destination: /index.html
